var tribe_aggregator=tribe_aggregator||{};tribe_aggregator.fields={selector:{container:".tribe-ea",form:".tribe-ea-form",help:".tribe-ea-help",fields:".tribe-ea-field",dropdown:".tribe-ea-dropdown",origin_field:"#tribe-ea-field-origin",media_button:".tribe-ea-media_button",datepicker:".tribe-ea-datepicker",save_credentials_button:".enter-credentials .tribe-save",preview_container:".tribe-preview-container",preview_button:".tribe-preview:visible",refine_filters:".tribe-refine-filters",clear_filters_button:".tribe-clear-filters",finalize_button:".tribe-finalize",cancel_button:".tribe-cancel",action:"#tribe-action"},media:{},$:{},construct:{},events:{},import_id:null,result_fetch_count:0,max_result_fetch_count:5,polling_frequency_index:0,polling_frequencies:[500,1e3,5e3,2e4]},function(e,t,a,r){"use strict";a.init=function(){a.$.container=e(a.selector.container),a.$.form=e(a.selector.form),a.$.action=e(a.selector.action),a.$.fields=a.$.container.find(a.selector.fields),a.$.preview_container=e(a.selector.preview_container),e.each(a.construct,function(e,t){t(a.$.fields)});var t=e(document.getElementById("eventDetails"));t.data("datepicker_format")&&(tribe_ev.state.datepicker_format=t.data("datepicker_format")),e(document).on("keypress",a.selector.fields,a.events.trigger_field_change).on("click",a.selector.save_credentials_button,a.events.trigger_save_credentials).on("click",a.selector.clear_filters_button,a.clear_filters).on("click",a.selector.finalize_button,a.finalize_manual_import).on("click",".tribe-preview",a.preview_import).on("click",".tribe-cancel",a.events.cancel_edit).on("change",a.selector.origin_field,function(){a.$.form.removeClass("show-data"),a.$.form.attr("data-origin",e(this).val()),e(".tribe-fetched, .tribe-fetching, .tribe-fetch-error").removeClass("tribe-fetched tribe-fetching tribe-fetch-error"),"redirect"===e(this).val()&&(document.location="https://theeventscalendar.com/wordpress-event-aggregator/?utm_source=importoptions&utm_medium=plugin-tec&utm_campaign=in-app")}).on("submit",".tribe-ea-tab-new",a.events.suppress_submission),e(".tribe-dependency").change(),"edit"===a.$.action.val()&&(a.$.form.addClass("edit-form"),e(a.selector.finalize_button).html(r.l10n.edit_save))},a.preview_import=function(){a.reset_polling_counter();var t=e("#tribe-post_id");t.data("value",t.val()),t.val("");var r=e("#tribe-import_id");r.data("value",r.val()),r.val("");var i=e(a.selector.preview_button),n=i.closest("form"),o=n.serialize();t.val(t.data("value")),r.val(t.data("value")),a.$.preview_container.addClass("tribe-fetching").removeClass("tribe-fetch-error"),a.$.form.removeClass("show-data"),i.prop("disabled",!0);var l=e(".dataTable").data("table");"undefined"!=typeof l&&l.clear().draw(),"edit"===a.$.action.val()?a.preview_save_import(o):a.create_import(o)},a.reset_polling_counter=function(){a.polling_frequency_index=0,a.result_fetch_count=0},a.reset_form=function(){a.$.fields.val("").trigger("change"),e(".tribe-ea-dropdown").select2("data",null),e('[id$="import_frequency"]').val("daily").trigger("change"),a.$.form.removeClass("show-data")},a.clear_filters=function(){e(a.selector.refine_filters).find("input, select").val("").trigger("change")},a.preview_save_import=function(t){var r=e.ajax({type:"POST",url:ajaxurl+"?action=tribe_aggregator_preview_import",data:t,dataType:"json"});r.done(a.handle_preview_create_results)},a.create_import=function(t){var r=e.ajax({type:"POST",url:ajaxurl+"?action=tribe_aggregator_create_import",data:t,dataType:"json"});r.done(a.handle_preview_create_results)},a.handle_preview_create_results=function(t){return t.success?(a.import_id=t.data.data.import_id,e("#tribe-import_id").val(a.import_id),"undefined"!=typeof t.data.data.items?(a.init_datatable(t.data.data),void a.$.preview_container.removeClass("tribe-fetching").addClass("tribe-fetched")):void setTimeout(a.poll_for_results,a.polling_frequencies[a.polling_frequency_index])):void a.display_fetch_error(["<b>",r.l10n.preview_fetch_error_prefix,"</b>"," "+t.data.message].join(" "))},a.poll_for_results=function(){a.result_fetch_count++;var t=e.ajax({type:"GET",url:ajaxurl+"?action=tribe_aggregator_fetch_import&import_id="+a.import_id,dataType:"json"});t.done(function(t){if(!t.success){var i;return"undefined"!=typeof t.data.message?i=t.data.message:"undefined"!=typeof t.data[0].message&&(i=t.data[0].message),void a.display_fetch_error(["<b>",r.l10n.preview_fetch_error_prefix,"</b>"," "+i].join(" "))}"error"===t.data.status?a.display_fetch_error(t.data.message):"success"!==t.data.status?(a.result_fetch_count>a.max_result_fetch_count&&(a.polling_frequency_index++,a.result_fetch_count=0),"undefined"==typeof a.polling_frequencies[a.polling_frequency_index]?a.display_fetch_error(r.l10n.preview_timeout):setTimeout(a.poll_for_results,a.polling_frequencies[a.polling_frequency_index])):(t.data.data.items=t.data.data.events,a.init_datatable(t.data.data),a.$.preview_container.removeClass("tribe-fetching").addClass("tribe-fetched"),e(a.selector.preview_button).prop("disabled",!1))})},a.init_datatable=function(t){var i=!1,n=e(a.selector.origin_field).val(),o="csv"===n,l=e('[id$="import_type"]:visible'),s="manual";if("undefined"!=typeof r.default_settings[n])for(var c in r.default_settings[n])if(r.default_settings[n].hasOwnProperty(c)){var d=e("#tribe-ea-field-"+c);d.val(r.default_settings[n][c]).select2("val",r.default_settings[n][c]).trigger("change")}if(l.length&&(s=e("#"+l.first().attr("id").replace("s2id_","")).val()),"manual"===s&&!t.items.length)return void a.display_fetch_error(r.l10n.no_results);l.length&&"manual"!==s||(i=!0);var u=a.$.preview_container.find(".data-container table"),p=[];for(var f in t.items){var _=t.items[f];_.checkbox=i?'<input type="checkbox">':"",p.push(_)}i&&!o?u.addClass("display-checkboxes"):u.removeClass("display-checkboxes"),a.$.form.addClass("show-data");var v={lengthMenu:[[5,10,25,50,-1],[5,10,25,50,tribe_l10n_datatables.pagination.all]],order:[[1,"asc"]],columnDefs:[{cellType:"th",className:"check-column",orderable:!1,targets:0}],data:p};if("undefined"!=typeof t.columns){v.columns=[{data:"checkbox"}];var m=u.find("thead tr"),g=u.find("tfoot tr"),h=e({}),b="",w="";if(m.find("th:first").nextAll().remove(),g.find("th:first").nextAll().remove(),o){var x=u.closest(".data-container");u.closest(".data-container").addClass("csv-data"),x.find(".tribe-preview-message .tribe-csv-filename").html(e("#tribe-ea-field-csv_file_name").text()),m.closest("thead").prepend('<tr class="tribe-column-map"><th scope="row" class="check-column column-cb"></th></tr>'),h=e(".tribe-column-map"),w=e("#tribe-ea-field-csv_content_type").val(),w=w.replace("tribe_","");var y=e("#tribe-csv-column-map-"+w);b=y.html()}var k=0;for(f in t.columns){if(v.columns.push({data:t.columns[f]}),m.append('<th scope="col">'+t.columns[f]+"</th>"),g.append('<th scope="col">'+t.columns[f]+"</th>"),o){var $=t.columns[f].toLowerCase().replace(" ","_").replace(/[^a-z0-9_]/,"");h.append('<th scope="col">'+b.replace('name="column_map[]"','name="aggregator[column_map]['+k+']" id="column-'+k+'"')+"</th>");var S=h.find("#column-"+k);"undefined"!=typeof r.csv_column_mapping[w][k]&&($=r.csv_column_mapping[w][k]),S.find('option[value="'+$+'"]').prop("selected",!0)}k++}v.scrollX=!0}else v.columns=[{data:"checkbox"},{data:"start_date"},{data:"end_date"},{data:"title"}],v.autoWidth=!1;u.tribeDataTable(v),a.wrap_cell_content(),u.on("select.dt",a.events.twiddle_finalize_button_text).on("deselect.dt",a.events.twiddle_finalize_button_text).on("draw.dt",a.wrap_cell_content);var C;"new"===a.$.action.val()&&(C="manual"===s?r.l10n.import_all.replace("%d",p.length):r.l10n.create_schedule),e(a.selector.finalize_button).html(C)},a.wrap_cell_content=function(){e(".dataTable").find("tbody td").each(function(){var t=e(this);t.html('<div class="tribe-td-height-limit">'+t.html()+"</div>")})},a.display_fetch_error=function(t){var r=e(".tribe-fetch-error-message");a.$.preview_container.removeClass("tribe-fetching").addClass("tribe-fetch-error"),r.html(""),a.display_error(r,t),e(a.selector.preview_button).prop("disabled",!1)},a.display_error=function(e,t){e.prepend(['<div class="notice notice-error">',"<p>",t,"</p>","</div>"].join(""))},a.save_credentials=function(t){var a=t.find(".tribe-fieldset").find("input").serialize(),r=ajaxurl+"?action=tribe_aggregator_save_credentials",i=e.post(r,a);i.done(function(e){e.success&&(t.addClass("credentials-entered"),t.find('[name="has-credentials"]').val(1).change())})},a.finalize_manual_import=function(){var t=e("#tribe-ea-field-origin").val(),i=e(".dataTable"),n=window.tribe_data_table;if("eventbrite"===t)return void a.$.form.submit();if(i.hasClass("display-checkboxes")){var o=n.rows({selected:!0});if(o[0].length||(o=n.rows()),!o[0].length)return void a.display_error(e(".tribe-finalize-container"),r.l10n.events_required_for_manual_submit);var l=o.data(),s=[],c=null;if("facebook"===t?c="facebook_id":"meetup"===t?c="meetup_id":"ical"!==t&&"ics"!==t&&"gcal"!==t||(c="uid"),null!==c){for(var d in l)isNaN(d)||"undefined"!=typeof l[d][c]&&s.push(l[d][c]);e("#tribe-selected-rows").text(JSON.stringify(s))}else e("#tribe-selected-rows").text("all")}else e("#tribe-selected-rows").text("all");e(".dataTables_scrollBody").find('[name^="aggregator[column_map]"]').remove(),a.$.form.submit()},a.search_id=function(e){var t=null;return"undefined"!=typeof e.id?t=e.id:"undefined"!=typeof e.ID?t=e.ID:"undefined"!=typeof e.value&&(t=e.value),void 0==e?null:t},a.construct.dropdown=function(r){var i=r.filter(a.selector.dropdown).not(".select2-offscreen, .select2-container");return i.each(function(){var r=e(this),i={};if(r.is("select")||(i.id=a.search_id),i.allowClear=!0,r.is("[data-prevent-clear]")&&(i.allowClear=!1),r.is("[data-options]")&&(i.data=r.data("options")),r.is("[data-hide-search]")&&(i.minimumResultsForSearch=1/0),r.is("[multiple]")&&(i.multiple=!0,t.isArray(r.data("separator"))?i.tokenSeparators=r.data("separator"):i.tokenSeparators=[r.data("separator")],i.separator=r.data("separator"),i.regexSeparatorElements=["^("],i.regexSplitElements=["(?:"],e.each(i.tokenSeparators,function(e,t){i.regexSeparatorElements.push("[^"+t+"]+"),i.regexSplitElements.push("["+t+"]")}),i.regexSeparatorElements.push(")$"),i.regexSplitElements.push(")"),i.regexSeparatorString=i.regexSeparatorElements.join(""),i.regexSplitString=i.regexSplitElements.join(""),i.regexToken=new RegExp(i.regexSeparatorString,"ig"),i.regexSplit=new RegExp(i.regexSplitString,"ig")),i.matcher=function(e,r){var n=0==r.toUpperCase().indexOf(e.toUpperCase());if(!n&&"undefined"!=typeof i.tags){var o=t.where(i.tags,{text:r});if(i.tags.length>0&&t.isObject(o)){var l=a.search_id(o[0]);n=0==l.toUpperCase().indexOf(e.toUpperCase())}}return n},r.is("[data-tags]")&&(i.tags=r.data("options"),i.initSelection=function(a,r){var n=[];e(a.val().split(i.regexSplit)).each(function(){var e={id:this,text:this};if(i.tags.length>0&&t.isObject(i.tags[0])){var a=t.where(i.tags,{value:this});a.length>0&&(e=a[0],e={id:e.value,text:e.text})}n.push(e)}),r(n)},i.createSearchChoice=function(e,t){if(e.match(i.regexToken))return{id:e,text:e}},0===i.tags.length&&(i.formatNoMatches=function(){return r.attr("placeholder")})),r.is("[data-source]")){var n=r.data("source");i.data={results:[]},i.escapeMarkup=function(e){return e},i.ajax={dataType:"json",type:"POST",url:window.ajaxurl,results:function(e){return e.data}},i.ajax.data=function(e,t){return{action:"tribe_aggregator_dropdown_"+n}}}r.select2(i)}).on("change",function(a){var r=e(this),i=e(this).data("value");r.is("[multiple]")&&r.is("[data-source]")&&(a.added?t.isArray(i)?i.push(a.added):i=[a.added]:i=t.isArray(i)?t.without(i,a.removed):[],r.data("value",i).attr("data-value",JSON.stringify(i)))}),i},a.construct.media_button=function(t){var r=t.filter(a.selector.media_button);return"undefined"!=typeof wp&&wp.media&&wp.media.editor?(r.each(function(){var t=e(this),r=t.data("input"),i=e("#"+r),n=e("#"+r+"_name"),o=a.media[r]=wp.media({title:t.data("mediaTitle"),library:{type:t.data("mimeType")},multiple:!1});o.on("select",function(){var e=o.state(),t=e.get("selection");t&&t.each(function(e){i.data({id:e.attributes.id,text:e.attributes.title}),i.val(e.attributes.id),i.change(),n.html(e.attributes.filename),n.attr("title",e.attributes.filename)})})}),a.$.container.on("click",a.selector.media_button,function(t){if(t.preventDefault(),e(this).is(":visible")){var r=e(this).data("input");return a.media[r].open(r),!1}}),r):r},a.events.trigger_field_change=function(){e(this).change()},a.events.trigger_save_credentials=function(){a.save_credentials(e(this).closest(".enter-credentials"))},a.events.suppress_submission=function(t){var a=e("#tribe-ea-field-origin").val();return!(!e("#tribe-selected-rows").val().length&&"eventbrite"!==a)||void t.preventDefault()},a.events.twiddle_finalize_button_text=function(t,i){if("new"===a.$.action.val()){var n=i.rows({selected:!0})[0].length,o=r.l10n.import_checked;n||(o=r.l10n.import_all,n=i.rows()[0].length),o=o.replace("%d",n),e(a.selector.finalize_button).html(o)}},a.events.cancel_edit=function(e){e.preventDefault();var t=window.location.href;t=t.replace("tab=edit","tab=scheduled"),t=t.replace(/id=\d+/,""),window.location.href=t},e(document).ready(a.init)}(jQuery,_,tribe_aggregator.fields,tribe_aggregator);